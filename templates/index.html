<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品净值比较(受保护的数据)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center mb-4">产品净值比较(受保护的数据)</h1>

    <!-- 主内容 -->
    <div id="mainContent">
        <!-- 筛选 -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="strategySelect" class="form-label">选择产品策略：</label>
                <select id="strategySelect" class="form-select">
                    <option value="">-- 选择产品策略 --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="searchInput" class="form-label">搜索产品：</label>
                <input type="text" id="searchInput" class="form-control" placeholder="输入关键字，逗号分隔">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button id="searchButton" class="btn btn-primary w-100 me-2">搜索并展示</button>
                <button id="searchAddButton" class="btn btn-secondary w-100">搜索并添加</button>
            </div>
        </div>

        <!-- 数据表 -->
        <table id="productTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <!-- 表头动态填充 -->
                </tr>
            </thead>
            <tbody>
                <!-- 数据动态填充 -->
            </tbody>
        </table>

        <!-- 图表生成 -->
        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button id="generateChartButton" class="btn btn-success">生成合并图表</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const password = prompt("请输入访问密码：");
        let sortColumn = null; // 当前排序列
        let sortOrder = "asc"; // 当前排序顺序
        $("#mainContent").show();
    
        // 动态加载策略选项
        function loadStrategies() {
            $.get("/strategies")
                .done(function (data) {
                    if (data.strategies && data.strategies.length > 0) {
                        const strategySelect = $("#strategySelect");
                        strategySelect.empty();
                        strategySelect.append('<option value="">-- 选择产品策略 --</option>');
                        data.strategies.forEach(strategy => {
                            strategySelect.append(`<option value="${strategy}">${strategy}</option>`);
                        });
                    } else {
                        const password = prompt("请输入访问密码："); // 如果返回空数据，触发登录
                    }
                })
                .fail(function () {
                    alert("加载策略选项失败！");
                });
        }
    
        // 动态加载表格数据
        function loadTableData() {
            $.get("/table_data")
                .done(function (data) {
                    if (data.columns && data.columns.length > 0) {
                        renderTable(data.columns, data.data);
                    } else {
                        const password = prompt("请输入访问密码："); // 如果返回空数据，触发登录
                    }
                })
                .fail(function () {
                    alert("加载表格数据失败！");
                });
        }
    
        loadStrategies(); 
        loadTableData();// 初始调用登录流程
    
        // 渲染表格数据
        function renderTable(columns, data) {
            const tableHead = $("#productTable thead tr");
            const tableBody = $("#productTable tbody");
            tableHead.empty();
            tableBody.empty();
    
            // 渲染表头
            columns.forEach(column => {
                tableHead.append(`<th class="sortable" data-column="${column}">${column}</th>`);
            });
            tableHead.append("<th>操作</th>");
    
            // 渲染数据
            data.forEach(row => {
                let tableRow = "<tr>";
                columns.forEach(column => {
                    tableRow += `<td>${row[column] || ""}</td>`;
                });
                tableRow += `
                    <td>
                        <button class="btn btn-danger btn-sm delete-row" data-code="${row['产品代码']}">删除</button>
                        <button class="btn btn-info btn-sm download-chart" data-code="${row['产品代码']}">下载图表</button>
                    </td>`;
                tableRow += "</tr>";
                tableBody.append(tableRow);
            });
        }

        // 筛选数据
        $("#strategySelect").change(function () {
            const strategy = $(this).val();
            $.post("/filter", {strategy: strategy, password: password})
                .done(function (data) {
                    renderTable(data.columns, data.data);
                })
                .fail(function () {
                    alert("筛选失败！");
                });
        });

        // 搜索并展示
        $("#searchButton").click(function () {
            const keywords = $("#searchInput").val();
            if (!keywords.trim()) {
                alert("请输入搜索关键字！");
                return;
            }

            $.post("/search", {keywords: keywords, password: password})
                .done(function (data) {
                    renderTable(data.columns, data.data);
                })
                .fail(function () {
                    alert("搜索失败！");
                });
        });

        // 搜索并添加
        $("#searchAddButton").click(function () {
            const keywords = $("#searchInput").val();
            if (!keywords.trim()) {
                alert("请输入搜索关键字！");
                return;
            }

            $.post("/search", {keywords: keywords, password: password})
                .done(function (data) {
                    if (Array.isArray(data)) {
                        const tableBody = $("#productTable tbody");
                        const existingProductCodes = new Set();
                        // 获取当前表格中所有产品代码
                        $("#productTable tbody tr").each(function () {
                            const productCode = $(this).find("td:first").text();
                            existingProductCodes.add(productCode);
                        });

                        // 确保不重复添加已存在的数据
                        data.forEach(row => {
                            if (!existingProductCodes.has(row["产品代码"])) {
                                let tableRow = "<tr>";
                                Object.keys(row).forEach(key => {
                                    tableRow += `<td>${row[key] || ""}</td>`;
                                });
                                tableRow += `
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-row" data-code="${row["产品代码"]}">删除</button>
                                        <button class="btn btn-info btn-sm download-chart" data-code="${row["产品代码"]}">下载图表</button>
                                    </td>`;
                                tableRow += "</tr>";
                                tableBody.prepend(tableRow); // 插入到表格顶部
                            }
                        });
                    } else {
                        alert("搜索失败：无效的响应数据！");
                    }
                })
                .fail(function () {
                    alert("搜索失败！");
                });
        });

        // 删除数据
        $(document).on("click", ".delete-row", function () {
            const productCode = $(this).data("code");
            if (confirm("确定要删除该产品吗？")) {
                $.post("/delete_row", {product_code: productCode})
                    .done(function () {
                        alert("删除成功！");
                        loadTableData();
                    })
                    .fail(function () {
                        alert("删除失败！");
                    });
            }
        });

        // 下载图表
        $(document).on("click", ".download-chart", function () {
            const productCode = $(this).data("code");
            window.location.href = `/download_chart/${productCode}`;
        });

        // 点击“生成合并图表”按钮
        $("#generateChartButton").click(function () {
            const productCodes = [];
            $("#productTable tbody tr").each(function () {
                const productCode = $(this).find("td:first").text();
                productCodes.push(productCode);
            });

            if (productCodes.length === 0) {
                alert("没有产品可生成图表！");
                return;
            }

            $.post("/add_chart", {product_codes: productCodes, password: password})
                .done(function (data) {
                    if (data.success && data.chart_path) {
                        alert("合并图表生成成功！");
                        window.open(data.chart_path, "_blank");
                    } else {
                        alert("生成合并图表失败！");
                    }
                })
                .fail(function () {
                    alert("生成合并图表请求失败！");
                });
        });
    });
</script>
</body>
</html>
