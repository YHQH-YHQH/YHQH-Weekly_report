<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品净值比较(受保护的数据)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center mb-4">产品净值比较(受保护的数据)</h1>

    <!-- 主内容 -->
    <div id="mainContent">
        <!-- 筛选 -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="strategySelect" class="form-label">选择产品策略：</label>
                <select id="strategySelect" class="form-select">
                    <option value="">-- 选择产品策略 --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="searchInput" class="form-label">搜索产品：</label>
                <input type="text" id="searchInput" class="form-control" placeholder="输入关键字，逗号分隔">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button id="searchButton" class="btn btn-primary w-100 me-2">搜索并展示</button>
                <button id="searchAddButton" class="btn btn-secondary w-100">搜索并添加</button>
            </div>
        </div>

        <!-- 数据表 -->
        <table id="productTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <!-- 表头动态填充 -->
                </tr>
            </thead>
            <tbody>
                <!-- 数据动态填充 -->
            </tbody>
        </table>

        <!-- 图表生成 -->
        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button id="generateChartButton" class="btn btn-success">生成合并图表</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const password = prompt("请输入访问密码：");
        let currentSortOrder = []; // 当前排序顺序的列 [{ column: "列名", order: "asc" }]
        $("#mainContent").show();
    
        // 动态加载策略选项
        function loadStrategies() {
            $.post("/strategies", { password: password })  // 使用 POST 发送密码
                .done(function (data) {
                    if (data.strategies && data.strategies.length > 0) {
                        const strategySelect = $("#strategySelect");
                        strategySelect.empty();
                        strategySelect.append('<option value="">-- 选择产品策略 --</option>');
                        data.strategies.forEach(strategy => {
                            strategySelect.append(`<option value="${strategy}">${strategy}</option>`);
                        });
                    } else if (data.error) {
                        alert(data.error);  // 如果后端返回密码错误
                        location.reload();  // 重新加载页面以重新登录
                    }
                })
                .fail(function () {
                    alert("加载策略选项失败！");
                });
        }
    
        // 动态加载表格数据
        function loadTableData() {
            $.post("/table_data", { password: password })  // 使用 POST 发送密码
                .done(function (data) {
                    if (data.columns && data.columns.length > 0) {
                        renderTable(data.columns, data.data);
                    } else if (data.error) {
                        alert(data.error);  // 如果后端返回密码错误
                        location.reload();  // 重新加载页面以重新登录
                    }
                })
                .fail(function () {
                    alert("加载表格数据失败！");
                });
        }
    
        loadStrategies(); 
        loadTableData();// 初始调用登录流程
    
        // 渲染表格数据
        function renderTable(columns, data) {
            const tableHead = $("#productTable thead tr");
            const tableBody = $("#productTable tbody");
            tableHead.empty();
            tableBody.empty();
        
            // 渲染表头
            columns.forEach(column => {
                tableHead.append(`<th>${column}</th>`);
            });
            tableHead.append("<th>操作</th>");
        
            // 渲染数据
            data.forEach(row => {
                let tableRow = "<tr>";
                columns.forEach(column => {
                    const cellValue = row[column] || "";
        
                    // 特殊处理需要颜色的列
                    if (
                        column === "年化收益率" ||
                        column === "本周收益率" ||
                        column === "上周收益率" ||
                        column === "本年收益"
                    ) {
                        // 解析数值并判断正负
                        const numericValue = parseFloat(cellValue.replace(/%/g, "")); // 去掉百分号
                        if (!isNaN(numericValue)) {
                            const color = numericValue > 0 ? "red" : numericValue < 0 ? "green" : "black";
                            tableRow += `<td style="color: ${color};">${cellValue}</td>`;
                        } else {
                            // 非数值情况（如空值）
                            tableRow += `<td>${cellValue}</td>`;
                        }
                    } else {
                        // 普通列直接添加
                        tableRow += `<td>${cellValue}</td>`;
                    }
                });
        
                // 添加操作按钮
                tableRow += `
                    <td>
                        <button class="btn btn-danger btn-sm delete-row" data-code="${row["产品代码"]}">删除</button>
                        <button class="btn btn-info btn-sm download-chart" data-code="${row["产品代码"]}">下载图表</button>
                    </td>`;
                tableRow += "</tr>";
                tableBody.append(tableRow);
            });
        }


        // 筛选数据
        $("#strategySelect").change(function () {
            const strategy = $(this).val();
            $.post("/filter", {strategy: strategy, password: password})
                .done(function (data) {
                    renderTable(data.columns, data.data);
                })
                .fail(function () {
                    alert("筛选失败！");
                });
        });

        // 搜索并展示
        $("#searchButton").click(function () {
            const keywords = $("#searchInput").val();
            if (!keywords.trim()) {
                alert("请输入搜索关键字！");
                return;
            }

            $.post("/search", {keywords: keywords, password: password})
                .done(function (data) {
                    renderTable(data.columns, data.data);
                })
                .fail(function () {
                    alert("搜索失败！");
                });
        });

        // 搜索并添加
        $("#searchAddButton").click(function () {
            const keywords = $("#searchInput").val();
            if (!keywords.trim()) {
                alert("请输入搜索关键字！");
                return;
            }
        
            $.post("/search", { keywords: keywords, password: password })
                .done(function (data) {
                    console.log("Search response:", data); // 打印返回数据
        
                    // 检查返回数据格式
                    if (data.columns && Array.isArray(data.columns) && data.data && Array.isArray(data.data)) {
                        const tableBody = $("#productTable tbody");
                        const existingProductCodes = new Set();
        
                        // 获取当前表格中所有产品代码
                        $("#productTable tbody tr").each(function () {
                            const productCode = $(this).find("td:first").text();
                            existingProductCodes.add(productCode);
                        });
        
                        // 确保不重复添加已存在的数据
                        data.data.forEach(row => {
                            if (!existingProductCodes.has(row["产品代码"])) {
                                let tableRow = "<tr>";
                                // 按列顺序渲染数据
                                data.columns.forEach(column => {
                                    tableRow += `<td>${row[column] || ""}</td>`;
                                });
                                tableRow += `
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-row" data-code="${row["产品代码"]}">删除</button>
                                        <button class="btn btn-info btn-sm download-chart" data-code="${row["产品代码"]}">下载图表</button>
                                    </td>`;
                                tableRow += "</tr>";
                                tableBody.prepend(tableRow); // 插入到表格顶部
                            }
                        });
                    } else {
                        alert("搜索失败：无效的响应数据！");
                    }
                })
                .fail(function () {
                    alert("搜索失败！");
                });
        });



        // 删除数据
        $(document).on("click", ".delete-row", function () {
            const productCode = $(this).data("code");
        
            if (confirm("确定要删除该产品吗？")) {
                $.post("/delete_row", { product_code: productCode })
                    .done(function (response) {
                        if (response.success) {
                            alert("删除成功！");
        
                            // 检查表格中是否还有其他行
                            const rows = $("#productTable tbody tr");
                            if (rows.length > 1) {
                                // 只删除当前行
                                $(`button[data-code="${productCode}"]`).closest("tr").remove();
                            } else {
                                // 如果是最后一行，刷新表格并显示所有产品
                                loadTableData();
                            }
                        } else {
                            alert("删除失败！");
                        }
                    })
                    .fail(function () {
                        alert("删除失败！");
                    });
            }
        });

        // 初始化表格头部点击事件
        $("#productTable thead").on("click", "th", function () {
            const column = $(this).text(); // 获取列名
            if (!column) return; // 忽略空列点击
    
            // 更新当前排序逻辑
            updateSortOrder(column);
    
            // 获取表格行数据
            const rows = $("#productTable tbody tr").toArray();
    
            // 按排序规则排序
            rows.sort((a, b) => {
                for (let { column, order } of currentSortOrder) {
                    const colIndex = $("#productTable thead th").filter((_, th) => $(th).text() === column).index();
                    const valA = $(a).find("td").eq(colIndex).text().trim();
                    const valB = $(b).find("td").eq(colIndex).text().trim();
    
                    // 按数值或字符串排序
                    let comparison = compareValues(valA, valB, order);
                    if (comparison !== 0) return comparison; // 如果不相等，停止比较
                }
                return 0; // 如果所有列都相等
            });
    
            // 重新渲染排序后的行
            $("#productTable tbody").empty().append(rows);
        });
    
        // 更新排序顺序逻辑
        function updateSortOrder(column) {
            const existingIndex = currentSortOrder.findIndex((rule) => rule.column === column);
    
            if (existingIndex >= 0) {
                // 如果当前列已经存在排序规则，则切换排序顺序
                currentSortOrder[existingIndex].order =
                    currentSortOrder[existingIndex].order === "asc" ? "desc" : "asc";
            } else {
                // 如果当前列不存在排序规则，添加为降序
                currentSortOrder.push({ column: column, order: "asc" });
            }
    
            // 确保最新点击的列排在优先级最前
            const newRule = currentSortOrder.splice(existingIndex, 1)[0]; // 删除旧规则
            currentSortOrder.unshift(newRule); // 将新规则放到最前
        }
    
        // 比较两个值（支持字符串和数值比较）
        function compareValues(a, b, order) {
            const numA = parseFloat(a.replace(/,/g, "")); // 转为数值（支持逗号格式）
            const numB = parseFloat(b.replace(/,/g, ""));
            const isNumeric = !isNaN(numA) && !isNaN(numB);
    
            if (isNumeric) {
                return order === "asc" ? numA - numB : numB - numA; // 数值比较
            } else {
                return order === "asc" ? a.localeCompare(b) : b.localeCompare(a); // 字符串比较
            }
        }
    
        // 下载图表
        $(document).on("click", ".download-chart", function () {
            const productCode = $(this).data("code");
            $.post(`/download_chart/${productCode}`, { password: password })
                .done(function (data) {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        // 创建隐藏链接并触发下载
                        const link = document.createElement("a");
                        link.href = `/output_charts/${productCode}_chart.html`;
                        link.download = `${productCode}_chart.html`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                })
                .fail(function () {
                    alert("下载图表失败！");
                });
        });

        // 点击“生成合并图表”按钮
        $("#generateChartButton").click(function () {
            const productCodes = [];
            $("#productTable tbody tr").each(function () {
                const productCode = $(this).find("td:first").text();
                productCodes.push(productCode);
            });

            if (productCodes.length === 0) {
                alert("没有产品可生成图表！");
                return;
            }

            $.post("/add_chart", {product_codes: productCodes, password: password})
                .done(function (data) {
                    if (data.success && data.chart_path) {
                        alert("合并图表生成成功！");
                        window.open(data.chart_path, "_blank");
                    } else {
                        alert("生成合并图表失败！");
                    }
                })
                .fail(function () {
                    alert("生成合并图表请求失败！");
                });
        });
    });
</script>
</body>
</html>
